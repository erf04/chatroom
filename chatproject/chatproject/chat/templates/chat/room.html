{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Room</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static 'style.css' %}" />
  </head>
  <body>
    <div class="mt-4 m-auto p-0 w-50 container">
      <!-- container -->
      <div
        class="container-fluid w-100 m-0 p-0 align-items-center justify-content-center rounded-5"
        id="container"
      >
        <!-- header -->
        <div
          class="row w-100 h-14 p-0 m-0 align-items-center justify-content-center rounded-top-4"
          id="header"
        >
          <!-- back button -->
          <div class="col-auto ms-2" id="back-button">
            <button type="button" class="btn w-auto p-0">
              <svg
                xmlns="arrow-left.svg"
                width="20"
                height="20"
                fill="currentColor"
                class="bi bi-arrow-left"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"
                />
              </svg>
            </button>
          </div>
          <!-- profile -->
          <div
            style="height: 60px; width: 60px"
            class="col-auto rounded-circle m-2 p-0"
            id="profile"
          >
            <img
              style="width: 60px; height: 60px"
              class="rounded-circle"
              src="{% static 'unknown.jpg' %}"
              id="img-prof"
            />
          </div>
          <!-- info -->
          <div class="col-auto p-0 me-auto" id="info">
            <div class="h3" id="name">name</div>
            <div class="display6" id="on-or-off">online</div>
          </div>
          <!-- menu -->
          <div class="col-auto me-1" id="menu">
            <button class="border-0 bg-light" id="menu-btn">
              <svg
                xmlns="three-dots.svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-three-dots"
                viewBox="0 0 16 16"
              >
                <path
                  d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"
                />
              </svg>
            </button>
          </div>
        </div>
        <!-- chat part -->
        <div id="chat-sagi" oncontextmenu="return false;">
          <!-- <div class="bg-dark d-block" id="chat-log"></div> -->
          <div class="d-block" id="chat-log"></div>
        </div>
        <!-- footer -->
        <div class="row p-0 m-0 w-100 h-14 align-items-center" id="footer">
          <!-- emoji -->
          <div class="col-1 p-0 m-0" id="emoji-sagi">
            <button
              onmouseenter="showEmoji()"
              onmouseleave="hideEmoji()"
              id="emoji"
              class="border-0 m-0 rounded-4"
            >
              <svg
                xmlns="emoji-smile.svg"
                width="28"
                height="28"
                class="bi bi-emoji-smile p-0 m-0"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
                />
                <path
                  d="M4.285 9.567a.5.5 0 0 1 .683.183A3.498 3.498 0 0 0 8 11.5a3.498 3.498 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.498 4.498 0 0 1 8 12.5a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z"
                />
              </svg>
            </button>
            <!-- emoji list -->
            <div
              class="dropup-content ms-4 bg-opacity-75 p-0 bg-light"
              id="emoji-list"
              onmouseenter="showEmoji()"
              onmouseleave="hideEmoji()"
            >
              <ul class="p-0">
                <li><a onclick="addEmoji(0)">&#128525;</a></li>
                <li><a onclick="addEmoji(1)">&#128512;</a></li>
                <li><a onclick="addEmoji(2)">&#128515;</a></li>
                <li><a onclick="addEmoji(3)">&#128516;</a></li>
                <li><a onclick="addEmoji(4)">&#128513;</a></li>
                <li><a onclick="addEmoji(5)">&#128518;</a></li>
                <li><a onclick="addEmoji(6)">&#128517;</a></li>
                <li><a onclick="addEmoji(7)">&#129315;</a></li>
                <li><a onclick="addEmoji(8)">&#128514;</a></li>
                <li><a onclick="addEmoji(9)">&#128578;</a></li>
                <li><a onclick="addEmoji(10)">&#128579;</a></li>
                <li><a onclick="addEmoji(11)">&#128521;</a></li>
                <li><a onclick="addEmoji(12)">&#128522;</a></li>
                <li><a onclick="addEmoji(13)">&#128519;</a></li>
                <li><a onclick="addEmoji(14)">&#129392;</a></li>
              </ul>
              <ul>
                <li><a onclick="addEmoji(15)">&#128525;</a></li>
                <li><a onclick="addEmoji(16)">&#129321;</a></li>
                <li><a onclick="addEmoji(17)">&#128536;</a></li>
                <li><a onclick="addEmoji(18)">&#128535;</a></li>
                <li><a onclick="addEmoji(19)">&#128538;</a></li>
                <li><a onclick="addEmoji(20)">&#128537;</a></li>
                <li><a onclick="addEmoji(21)">&#128523;</a></li>
                <li><a onclick="addEmoji(22)">&#128539;</a></li>
                <li><a onclick="addEmoji(23)">&#128540;</a></li>
                <li><a onclick="addEmoji(24)">&#129322;</a></li>
                <li><a onclick="addEmoji(25)">&#128541;</a></li>
                <li><a onclick="addEmoji(26)">&#129297;</a></li>
                <li><a onclick="addEmoji(27)">&#129303;</a></li>
                <li><a onclick="addEmoji(28)">&#129325;</a></li>
                <li><a onclick="addEmoji(29)">&#129323;</a></li>
              </ul>
              <ul>
                <li><a onclick="addEmoji(30)">&#129300;</a></li>
                <li><a onclick="addEmoji(31)">&#129296;</a></li>
                <li><a onclick="addEmoji(32)">&#129320;</a></li>
                <li><a onclick="addEmoji(33)">&#128528;</a></li>
                <li><a onclick="addEmoji(34)">&#128529;</a></li>
                <li><a onclick="addEmoji(35)">&#128566;</a></li>
                <li><a onclick="addEmoji(36)">&#128527;</a></li>
                <li><a onclick="addEmoji(37)">&#128530;</a></li>
                <li><a onclick="addEmoji(38)">&#128580;</a></li>
                <li><a onclick="addEmoji(39)">&#128556;</a></li>
                <li><a onclick="addEmoji(40)">&#128524;</a></li>
                <li><a onclick="addEmoji(41)">&#128532;</a></li>
                <li><a onclick="addEmoji(42)">&#128554;</a></li>
                <li><a onclick="addEmoji(43)">&#129316;</a></li>
                <li><a onclick="addEmoji(44)">&#128564;</a></li>
              </ul>
            </div>
          </div>
          <!-- message box -->
          <div class="col-9 p-1 m-0">
            <input
              class="p-1 me-auto w-100 border-0 form-control"
              type="text"
              placeholder="Type your message..."
              id="chat-message-input"
            />
          </div>
          <!-- attachment -->
          <div class="col-1 p-0 m-0" id="attachment">
            <label class="w-26 h-26">
              <i
                class="fa fa-paperclip"
                style="font-size: 30px"
                id="file-btn"
              ></i>
              <input type="file" />
            </label>
          </div>
          <!-- send button -->
          <div class="col-1 p-0 m-0" id="send-sagi">
            <button class="border-0 p-0 m-0" id="chat-message-submit">
              <svg
                xmlns="send.svg"
                width="25"
                height="25"
                class="bi bi-send"
                viewBox="0 0 16 16"
              >
                <path
                  d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- src="{% static bootstrap.bundle.min.js %}" -->
    <script
      src="	https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"
    ></script>
    <script src="{% static 'script.js' %}"></script>
    <script src="{% static '3a2eaf6206.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="{% static 'reconnecting-websocket.min.js' %}"></script>
    {{ room_name|json_script:"room-name" }}
    <script>
      var div = $('#chat-log');
      var chat = document.getElementById("chat-log");
      var chatSagi = document.getElementById("chat-sagi");
      var Height = chat.clientHeight;


      const roomName = JSON.parse(document.getElementById('room-name').textContent);
      document.getElementById("name").innerHTML = roomName;
      var username={{ username }};
      const chatSocket = new ReconnectingWebSocket(
          'ws://'
          + window.location.host
          + '/ws/chat/'
          + roomName
          + '/'
      );

      chatSocket.onopen = function(e) {
          chatSocket.send(JSON.stringify({
              "command":"fetch_message",
              "roomname":roomName
          }));
        }

      chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          var messageNum = data["message"].length;
          // console.log(data);
          if (data["command"] === "fetch_message"){
            // console.log(data);
            for(let i =0 ; i <=data["message"].length-1; i++){
              content = data["message"][i];
              create_chat(content, messageNum);
              // document.querySelector('#chat-log').innerHTML += (content + '\n');
            }
          } else {
              //console.log(data["message"]);
              create_chat(data["message"], messageNum);
              div.animate({scrollTop: Height * messageNum * 100}, 0);
              //document.querySelector('#chat-log').innerHTML += (data["message"]["content"] + '\n');
          }
      };

      var input = document.getElementById("chat-message-input");
      function create_chat(data, messages) {
        var data_div = document.createElement("div");
        var name = document.createElement("p");
        name.classList.add("name");
        var matn = document.createElement("p");
        matn.classList.add("matn");
        var date = document.createElement("p");
        date.classList.add("date");
        data_div.appendChild(name);
        data_div.appendChild(matn);
        data_div.appendChild(date);
        name.style.cursor = "default";
        matn.style.cursor = "text";
        date.style.cursor = "default";
        name.style.width = "fit-content";
        matn.style.width = "fit-content";
        const author = data["__str__"];
        name.innerHTML = author;
        // div.animate({scrollTop: Height * messages * 100}, 20000);
        div.animate({scrollTop: Height * (messages + 1) * 100}, 0);

        var time = "";
        for (let i = 11;;i++) {
          if (i === 16) {
            break;
          }
          time += data["timestamp"][i];
        }

        name.style.marginBottom = "7px";
        matn.style.marginBottom = "7px";
        matn.innerHTML = data["content"];
        date.style.color = "gray";
        date.style.margin = "0px";
        date.style.fontSize = "12px";
        date.innerHTML = time;
        data_div.style.maxWidth = "500px";
        data_div.style.minWidth = "100px";
        name.style.fontWeight = "bold";
        if (author == username) {
          data_div.classList.add("person1");
          data_div.style.marginLeft = "auto";
          matn.style.paddingLeft = "15px";
          data_div.style.direction = "rtl";
          matn.style.direction = "ltr";
          date.style.direction = "ltr";
        } else {
          data_div.classList.add("person2");
          matn.style.paddingRight = "15px";
          date.style.textAlign = "right";
        }
        chat.appendChild(data_div)
      }

      chatSagi.addEventListener("contextmenu", () => {
        alert("horaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa!");
      });

      chatSocket.onclose = function(e) {
          console.error('Chat socket closed unexpectedly');
      };

      document.querySelector('#chat-message-input').focus();
      document.querySelector('#chat-message-input').onkeyup = function(e) {
          if (e.key === 'Enter' && input.value !== "") {  // enter, return
              document.querySelector('#chat-message-submit').click();
              // div.animate({scrollTop: Height * 80 * 100}, 0);
          }
        };

      document.querySelector('#chat-message-submit').onclick = function(e) {
        if (input.value !== "") {
          const messageInputDom = document.querySelector('#chat-message-input');
          const message = messageInputDom.value;
          chatSocket.send(JSON.stringify({
              'message': message,
              'command':'new_message',
              'username':username,
              "roomname":roomName
          }));
          messageInputDom.value = '';
        }
      };
    </script>
  </body>
</html>

<!--
Ideas & problems:
  scroll missed a message
  typing into input box (new line)
  right click on a message and show setting:
    copy text
    reply
    speak
    delete
    edit
  dropdown on header:
    search
    clear chat
    change color
  sound when message recive (or send)
  good coloring
  dark mode (light mode)
  add or change profile
  number of members (instead of online or offline)
  sent message time
  attachment
-->
